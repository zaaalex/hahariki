{"version":3,"file":"project-modifier.bundle.js","sources":["../src/input-form/input-form-element/group-selector.js","../src/input-form/input-form.js","../src/project-modifier.js"],"sourcesContent":["import { Loc, Tag } from 'main.core';\nimport { BaseHeader, TagItem, TagSelector } from 'ui.entity-selector';\n\nclass DialogHeader extends BaseHeader\n{\n\trender(): HTMLElement\n\t{\n\t\treturn this.cache.remember('content', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<div class=\"project-modifier__project-selector-header\">\n\t\t\t\t\t${Loc.getMessage('PROJECT_MODIFIER_PROJECT_SELECTOR_TITLE')}\n\t\t\t\t</div>\n\t\t\t`;\n\t\t});\n\t}\n}\n\nexport class GroupSelector\n{\n\t#tagSelector: TagSelector;\n\n\tgetSelector(): TagSelector\n\t{\n\t\tthis.#tagSelector = new TagSelector({\n\t\t\taddButtonCaption: Loc.getMessage('PROJECT_MODIFIER_PROJECT_ADD_BTN_TITLE'),\n\t\t\tplaceholder: Loc.getMessage('PROJECT_MODIFIER_PROJECT_SELECTOR_PLACEHOLDER'),\n\t\t\tdialogOptions: {\n\t\t\t\theader: DialogHeader,\n\t\t\t\thideByEsc: true,\n\t\t\t\tenableSearch: true,\n\t\t\t\twidth: 400,\n\t\t\t\tcontext: 'PROJECT_MODIFIER',\n\t\t\t\tentities: this.#getGroupSelectorConfig(),\n\t\t\t},\n\t\t});\n\n\t\treturn this.#tagSelector;\n\t}\n\n\t#getGroupSelectorConfig(): Array\n\t{\n\t\treturn [\n\t\t\t{\n\t\t\t\tid: 'project',\n\t\t\t},\n\t\t];\n\t}\n\n\tgetSelectedTags(): TagItem[]\n\t{\n\t\treturn this.#tagSelector.getTags();\n\t}\n\n\tremoveSelectedTags(): void\n\t{\n\t\tthis.#tagSelector.removeTags();\n\t}\n}\n","import { Tag, Loc } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\nimport { GroupSelector } from './input-form-element/group-selector';\n\nimport '../../css/input-form.css';\n\nexport class InputForm extends EventEmitter\n{\n\t#groupSelector: GroupSelector;\n\n\tconstructor()\n\t{\n\t\tsuper();\n\t\tthis.#groupSelector = new GroupSelector();\n\n\t\tthis.setEventNamespace('ScrumTools.ProjectModifier.InputForm');\n\t}\n\n\tclearForm(): void\n\t{\n\t\tthis.#groupSelector.removeSelectedTags();\n\t}\n\n\tgetSelectedTags(): Array\n\t{\n\t\treturn this.#groupSelector.getSelectedTags();\n\t}\n\n\trender(): HTMLElement\n\t{\n\t\tconst { node, form, selectorContainer } = Tag.render`\n\t\t\t<section aria-label=\"Form for selecting projects for modernization\" ref=\"node\">\n\t\t\t\t<form class=\"project-modifier__choose-project-form\" ref=\"form\">\n\t\t\t\t\t<div class=\"project-modifier__project-selector\" ref=\"selectorContainer\"></div>\n\t\t\t\t\t<button \n\t\t\t\t\t\tclass=\"ui-btn ui-btn-primary project-modifier__submit-button\"\n\t\t\t\t\t\ttype=\"submit\"\n\t\t\t\t\t>\n\t\t\t\t\t\t${Loc.getMessage('PROJECT_MODIFIER_FORM_SUBMIT_BTN_TEXT')}\n\t\t\t\t\t</button>\n\t\t\t\t</form>\n\t\t\t</section>\n\t\t`;\n\n\t\tthis.#addGroupSelector(selectorContainer);\n\t\tthis.#addHint(form);\n\n\t\t// eslint-disable-next-line @bitrix24/bitrix24-rules/no-native-events-binding\n\t\tnode.addEventListener('submit', (event) => {\n\t\t\tevent.preventDefault();\n\t\t\tthis.emit('onProjectModifierFormSubmit');\n\t\t});\n\n\t\treturn node;\n\t}\n\n\t#addGroupSelector(node: HTMLElement): void\n\t{\n\t\tthis.#groupSelector.getSelector().renderTo(node);\n\t}\n\n\t#addHint(node: HTMLElement): void\n\t{\n\t\tnode.append(\n\t\t\tBX.UI.Hint.createNode(Loc.getMessage('PROJECT_MODIFIER_FORM_HINT')),\n\t\t);\n\t}\n}\n","import { NotificationService } from 'scrumtools.notification-service';\nimport { InputForm } from './input-form/input-form';\nimport { Loader } from 'main.loader';\nimport { Confetti } from 'ui.confetti';\nimport { MessageBox } from 'ui.dialogs.messagebox';\nimport { Loc, Dom, Type, Text } from 'main.core';\n\ntype ProjectModifierParams = {\n\tcontainer: HTMLElement;\n\tnotificationContainer: HTMLElement;\n};\n\nexport class ProjectModifier\n{\n\t#notificationService: NotificationService;\n\t#inputForm: InputForm;\n\t#loader: Loader;\n\n\t#container: HTMLElement;\n\t#notificationContainer: HTMLElement;\n\n\tconstructor(params: ProjectModifierParams)\n\t{\n\t\tthis.#checkParams(params);\n\n\t\tthis.#container = params.container;\n\t\tthis.#notificationContainer = params.notificationContainer;\n\n\t\tthis.#notificationService = new NotificationService();\n\t\tthis.#inputForm = new InputForm();\n\t\tthis.#loader = new Loader({\n\t\t\ttarget: this.#container,\n\t\t});\n\n\t\tthis.#handleEvents();\n\t}\n\n\t#checkParams(params: ProjectModifierParams): void\n\t{\n\t\tif (!Type.isDomNode(params.container))\n\t\t{\n\t\t\tthrow new TypeError('HTMLElement for render project modifier form not found');\n\t\t}\n\n\t\tif (!Type.isDomNode(params.notificationContainer))\n\t\t{\n\t\t\tthrow new TypeError('HTMLElement for render notification not found');\n\t\t}\n\t}\n\n\t#handleEvents(): void\n\t{\n\t\tthis.#inputForm.subscribe(\n\t\t\t'onProjectModifierFormSubmit',\n\t\t\t() => this.#onProjectModifierFormSubmit(),\n\t\t);\n\t}\n\n\tshowForm(): void\n\t{\n\t\tthis.#container.append(this.#inputForm.render());\n\t}\n\n\t#onProjectModifierFormSubmit(): void\n\t{\n\t\tMessageBox.show({\n\t\t\tmessage: Loc.getMessage('PROJECT_MODIFIER_FORM_HINT'),\n\t\t\tmodal: true,\n\t\t\tbuttons: BX.UI.Dialogs.MessageBoxButtons.OK_CANCEL,\n\t\t\tonOk: (messageBox) => {\n\t\t\t\tvoid this.#onConfirmModify();\n\t\t\t\tmessageBox.close();\n\t\t\t},\n\t\t\tonCancel: (messageBox) => {\n\t\t\t\tmessageBox.close();\n\t\t\t},\n\t\t});\n\t}\n\n\tasync #onConfirmModify(): Promise\n\t{\n\t\tDom.clean(this.#notificationContainer);\n\t\tthis.#showLoader();\n\n\t\tconst projectsList = this.#inputForm.getSelectedTags();\n\t\tif (projectsList.length === 0)\n\t\t{\n\t\t\tthis.#notificationService.renderError(\n\t\t\t\tthis.#notificationContainer,\n\t\t\t\tLoc.getMessage('PROJECT_MODIFIER_FORM_EMPTY_PROJECT_FIELD_ERROR'),\n\t\t\t);\n\n\t\t\tthis.#hideLoader();\n\n\t\t\treturn;\n\t\t}\n\n\t\tawait Promise.allSettled(projectsList.map((project: number) => this.#modifyProject(project.id)))\n\t\t\t.then((results) => {\n\t\t\t\tresults.forEach((result, number) => {\n\t\t\t\t\tif (result.status === 'fulfilled')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#onSuccessModified(projectsList[number].title.text);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (result.status === 'rejected')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#onUnsuccessfulModified(projectsList[number].title.text);\n\t\t\t\t\t\tconsole.error('Upgrading a Scrum project failed', result.reason.errors);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t})\n\t\t\t.catch((error) => {\n\t\t\t\tconsole.error(error);\n\t\t\t})\n\t\t;\n\n\t\tthis.#inputForm.clearForm();\n\t\tthis.#hideLoader();\n\t}\n\n\t#modifyProject(projectId: number): Promise\n\t{\n\t\treturn BX.ajax.runAction(\n\t\t\t'bitrix:scrumtools.Project.modifyProject',\n\t\t\t{\n\t\t\t\tdata: {\n\t\t\t\t\tprojectId,\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\t}\n\n\t#onSuccessModified(projectTitle: string): void\n\t{\n\t\tconst preparedTitle = Text.encode(projectTitle);\n\n\t\tBX.UI.Notification.Center.notify({\n\t\t\tcontent: Loc.getMessage('PROJECT_MODIFIER_FORM_HANDLE_SUCCESS', { '#PROJECT_TITLE#': preparedTitle }),\n\t\t});\n\n\t\tConfetti.fire();\n\t}\n\n\t#onUnsuccessfulModified(projectTitle: string): void\n\t{\n\t\tconst preparedTitle = Text.encode(projectTitle);\n\n\t\tthis.#notificationService.renderError(\n\t\t\tthis.#notificationContainer,\n\t\t\tLoc.getMessage('PROJECT_MODIFIER_FORM_PROCESSING_ERROR').replace('#PROJECT_TITLE#', preparedTitle),\n\t\t);\n\t}\n\n\t#showLoader(): void\n\t{\n\t\tvoid this.#loader.show();\n\t\tDom.addClass(this.#container, 'project-modifier__darkened');\n\t}\n\n\t#hideLoader(): void\n\t{\n\t\tvoid this.#loader.hide();\n\t\tDom.removeClass(this.#container, 'project-modifier__darkened');\n\t}\n}\n"],"names":["DialogHeader","BaseHeader","render","cache","remember","Tag","Loc","getMessage","GroupSelector","getSelector","TagSelector","addButtonCaption","placeholder","dialogOptions","header","hideByEsc","enableSearch","width","context","entities","getSelectedTags","getTags","removeSelectedTags","removeTags","id","InputForm","EventEmitter","constructor","setEventNamespace","clearForm","node","form","selectorContainer","addEventListener","event","preventDefault","emit","renderTo","append","BX","UI","Hint","createNode","ProjectModifier","params","container","notificationContainer","NotificationService","Loader","target","showForm","Type","isDomNode","TypeError","subscribe","MessageBox","show","message","modal","buttons","Dialogs","MessageBoxButtons","OK_CANCEL","onOk","messageBox","close","onCancel","Dom","clean","projectsList","length","renderError","Promise","allSettled","map","project","then","results","forEach","result","number","status","title","text","console","error","reason","errors","catch","projectId","ajax","runAction","data","projectTitle","preparedTitle","Text","encode","Notification","Center","notify","content","Confetti","fire","replace","addClass","hide","removeClass"],"mappings":";;;;;;;AAAA,CAGA,MAAMA,YAAY,SAASC,4BAAU,CACrC;GACCC,MAAM,GACN;KACC,OAAO,IAAI,CAACC,KAAK,CAACC,QAAQ,CAAC,SAAS,EAAE,MAAM;OAC3C,OAAOC,aAAG,CAACH,MAAM,cAAC;;OAEhB,CAA4D;;IAE9D,GAFII,aAAG,CAACC,UAAU,CAAC,yCAAyC,CAAC;MAG7D,CAAC;;CAEJ;CAAC;CAAA;AAED,CAAO,MAAMC,aAAa,CAC1B;GAAA;KAAA;OAAA;;KAAA;OAAA;OAAA;;;GAGCC,WAAW,GACX;KACC,4CAAI,gCAAgB,IAAIC,6BAAW,CAAC;OACnCC,gBAAgB,EAAEL,aAAG,CAACC,UAAU,CAAC,wCAAwC,CAAC;OAC1EK,WAAW,EAAEN,aAAG,CAACC,UAAU,CAAC,+CAA+C,CAAC;OAC5EM,aAAa,EAAE;SACdC,MAAM,EAAEd,YAAY;SACpBe,SAAS,EAAE,IAAI;SACfC,YAAY,EAAE,IAAI;SAClBC,KAAK,EAAE,GAAG;SACVC,OAAO,EAAE,kBAAkB;SAC3BC,QAAQ,0CAAE,IAAI;;MAEf,CAAC;KAEF,+CAAO,IAAI;;GAYZC,eAAe,GACf;KACC,OAAO,4CAAI,8BAAcC,OAAO,EAAE;;GAGnCC,kBAAkB,GAClB;KACC,4CAAI,8BAAcC,UAAU,EAAE;;CAEhC;CAAC,oCAjBA;GACC,OAAO,CACN;KACCC,EAAE,EAAE;IACJ,CACD;CACF;;;;AC9CD,CAIkC;CAAA;CAAA;AAElC,CAAO,MAAMC,SAAS,SAASC,6BAAY,CAC3C;GAGCC,WAAW,GACX;KACC,KAAK,EAAE;KAAC;OAAA;;KAAA;OAAA;;KAAA;OAAA;OAAA;;KACR,4CAAI,oCAAkB,IAAInB,aAAa,EAAE;KAEzC,IAAI,CAACoB,iBAAiB,CAAC,sCAAsC,CAAC;;GAG/DC,SAAS,GACT;KACC,4CAAI,kCAAgBP,kBAAkB,EAAE;;GAGzCF,eAAe,GACf;KACC,OAAO,4CAAI,kCAAgBA,eAAe,EAAE;;GAG7ClB,MAAM,GACN;KACC,MAAM;OAAE4B,IAAI;OAAEC,IAAI;OAAEC;MAAmB,GAAG3B,aAAG,CAACH,MAAM,oBAAC;;;;;;;;QAQjD,CAA0D;;;;GAI9D,GAJMI,aAAG,CAACC,UAAU,CAAC,uCAAuC,CAAC,CAI5D;KAED,4CAAI,wCAAmByB,iBAAiB;KACxC,4CAAI,sBAAUD,IAAI;;;KAGlBD,IAAI,CAACG,gBAAgB,CAAC,QAAQ,EAAGC,KAAK,IAAK;OAC1CA,KAAK,CAACC,cAAc,EAAE;OACtB,IAAI,CAACC,IAAI,CAAC,6BAA6B,CAAC;MACxC,CAAC;KAEF,OAAON,IAAI;;CAcb;CAAC,4BAXkBA,IAAiB,EACnC;GACC,4CAAI,kCAAgBrB,WAAW,EAAE,CAAC4B,QAAQ,CAACP,IAAI,CAAC;CACjD;CAAC,mBAEQA,IAAiB,EAC1B;GACCA,IAAI,CAACQ,MAAM,CACVC,EAAE,CAACC,EAAE,CAACC,IAAI,CAACC,UAAU,CAACpC,aAAG,CAACC,UAAU,CAAC,4BAA4B,CAAC,CAAC,CACnE;CACF;;CC7DgD;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;AAOjD,CAAO,MAAMoC,eAAe,CAC5B;GAQChB,WAAW,CAACiB,OAA6B,EACzC;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;OAAA;;KAAA;OAAA;OAAA;;KAAA;OAAA;OAAA;;KAAA;OAAA;OAAA;;KAAA;OAAA;OAAA;;KACC,4CAAI,8BAAcA,OAAM;KAExB,4CAAI,4BAAcA,OAAM,CAACC,SAAS;KAClC,4CAAI,oDAA0BD,OAAM,CAACE,qBAAqB;KAE1D,4CAAI,gDAAwB,IAAIC,kDAAmB,EAAE;KACrD,4CAAI,4BAAc,IAAItB,SAAS,EAAE;KACjC,4CAAI,sBAAW,IAAIuB,kBAAM,CAAC;OACzBC,MAAM,0CAAE,IAAI;MACZ,CAAC;KAEF,4CAAI;;GAwBLC,QAAQ,GACR;KACC,4CAAI,0BAAYZ,MAAM,CAAC,4CAAI,0BAAYpC,MAAM,EAAE,CAAC;;CAyGlD;CAAC,uBAhIa0C,MAA6B,EAC1C;GACC,IAAI,CAACO,cAAI,CAACC,SAAS,CAACR,MAAM,CAACC,SAAS,CAAC,EACrC;KACC,MAAM,IAAIQ,SAAS,CAAC,wDAAwD,CAAC;;GAG9E,IAAI,CAACF,cAAI,CAACC,SAAS,CAACR,MAAM,CAACE,qBAAqB,CAAC,EACjD;KACC,MAAM,IAAIO,SAAS,CAAC,+CAA+C,CAAC;;CAEtE;CAAC,0BAGD;GACC,4CAAI,0BAAYC,SAAS,CACxB,6BAA6B,EAC7B,8CAAM,IAAI,+DAA+B,CACzC;CACF;CAAC,yCAQD;GACCC,gCAAU,CAACC,IAAI,CAAC;KACfC,OAAO,EAAEnD,aAAG,CAACC,UAAU,CAAC,4BAA4B,CAAC;KACrDmD,KAAK,EAAE,IAAI;KACXC,OAAO,EAAEpB,EAAE,CAACC,EAAE,CAACoB,OAAO,CAACC,iBAAiB,CAACC,SAAS;KAClDC,IAAI,EAAGC,UAAU,IAAK;OACrB,6CAAK,IAAI,uCAAmB;OAC5BA,UAAU,CAACC,KAAK,EAAE;MAClB;KACDC,QAAQ,EAAGF,UAAU,IAAK;OACzBA,UAAU,CAACC,KAAK,EAAE;;IAEnB,CAAC;CACH;CAAC,mCAGD;GACCE,aAAG,CAACC,KAAK,yCAAC,IAAI,kDAAwB;GACtC,4CAAI;GAEJ,MAAMC,YAAY,GAAG,4CAAI,0BAAYjD,eAAe,EAAE;GACtD,IAAIiD,YAAY,CAACC,MAAM,KAAK,CAAC,EAC7B;KACC,4CAAI,8CAAsBC,WAAW,yCACpC,IAAI,mDACJjE,aAAG,CAACC,UAAU,CAAC,iDAAiD,CAAC,CACjE;KAED,4CAAI;KAEJ;;GAGD,MAAMiE,OAAO,CAACC,UAAU,CAACJ,YAAY,CAACK,GAAG,CAAEC,OAAe,4CAAK,IAAI,kCAAgBA,OAAO,CAACnD,EAAE,CAAC,CAAC,CAAC,CAC9FoD,IAAI,CAAEC,OAAO,IAAK;KAClBA,OAAO,CAACC,OAAO,CAAC,CAACC,MAAM,EAAEC,MAAM,KAAK;OACnC,IAAID,MAAM,CAACE,MAAM,KAAK,WAAW,EACjC;SACC,4CAAI,0CAAoBZ,YAAY,CAACW,MAAM,CAAC,CAACE,KAAK,CAACC,IAAI;;OAGxD,IAAIJ,MAAM,CAACE,MAAM,KAAK,UAAU,EAChC;SACC,4CAAI,oDAAyBZ,YAAY,CAACW,MAAM,CAAC,CAACE,KAAK,CAACC,IAAI;SAC5DC,OAAO,CAACC,KAAK,CAAC,kCAAkC,EAAEN,MAAM,CAACO,MAAM,CAACC,MAAM,CAAC;;MAExE,CAAC;IACF,CAAC,CACDC,KAAK,CAAEH,KAAK,IAAK;KACjBD,OAAO,CAACC,KAAK,CAACA,KAAK,CAAC;IACpB,CAAC;GAGH,4CAAI,0BAAYxD,SAAS,EAAE;GAC3B,4CAAI;CACL;CAAC,yBAEc4D,SAAiB,EAChC;GACC,OAAOlD,EAAE,CAACmD,IAAI,CAACC,SAAS,CACvB,yCAAyC,EACzC;KACCC,IAAI,EAAE;OACLH;;IAED,CACD;CACF;CAAC,6BAEkBI,YAAoB,EACvC;GACC,MAAMC,aAAa,GAAGC,cAAI,CAACC,MAAM,CAACH,YAAY,CAAC;GAE/CtD,EAAE,CAACC,EAAE,CAACyD,YAAY,CAACC,MAAM,CAACC,MAAM,CAAC;KAChCC,OAAO,EAAE9F,aAAG,CAACC,UAAU,CAAC,sCAAsC,EAAE;OAAE,iBAAiB,EAAEuF;MAAe;IACpG,CAAC;GAEFO,oBAAQ,CAACC,IAAI,EAAE;CAChB;CAAC,kCAEuBT,YAAoB,EAC5C;GACC,MAAMC,aAAa,GAAGC,cAAI,CAACC,MAAM,CAACH,YAAY,CAAC;GAE/C,4CAAI,8CAAsBtB,WAAW,yCACpC,IAAI,mDACJjE,aAAG,CAACC,UAAU,CAAC,wCAAwC,CAAC,CAACgG,OAAO,CAAC,iBAAiB,EAAET,aAAa,CAAC,CAClG;CACF;CAAC,wBAGD;GACC,KAAK,4CAAI,oBAAStC,IAAI,EAAE;GACxBW,aAAG,CAACqC,QAAQ,yCAAC,IAAI,2BAAa,4BAA4B,CAAC;CAC5D;CAAC,wBAGD;GACC,KAAK,4CAAI,oBAASC,IAAI,EAAE;GACxBtC,aAAG,CAACuC,WAAW,yCAAC,IAAI,2BAAa,4BAA4B,CAAC;CAC/D;;;;;;;;"}